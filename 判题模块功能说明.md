# 判题模块功能说明

## 概述

本判题模块支持四种题型的自动判题：
- **编程题** (programming)
- **选择题** (choice) 
- **判断题** (judge)
- **简答题** (short_answer)

## 判题逻辑详解

### 1. 编程题判题 (judge_programming_problem)

**特点：**
- 通过沙箱执行用户提交的代码
- 支持时间限制和内存限制
- 将用户输出与期望输出进行精确比对

**判题流程：**
1. 在沙箱中执行用户代码
2. 使用题目的测试用例作为输入
3. 比较输出结果与期望输出
4. 记录执行时间和内存使用情况

**状态说明：**
- `accepted`: 输出完全匹配
- `wrong_answer`: 输出不匹配
- `error`: 代码执行错误
- `time_limit_exceeded`: 超时
- `memory_limit_exceeded`: 内存超限

### 2. 选择题判题 (judge_choice_problem)

**特点：**
- 支持单选题和多选题
- 答案格式标准化处理
- 大小写和空格不敏感

**判题流程：**
1. 标准化用户答案和正确答案（去除空格，转小写）
2. 直接比较标准化后的答案
3. 支持多选题答案（如：A,B 或 B,A）

**状态说明：**
- `accepted`: 答案完全正确
- `wrong_answer`: 答案错误或未选择

**答案格式支持：**
- 单选题：A, B, C, D
- 多选题：A,B 或 B,A（顺序不敏感）
- 大小写不敏感：a 等同于 A
- 空格不敏感：A 等同于 " A "

### 3. 判断题判题 (judge_judge_problem)

**特点：**
- 支持多种答案表示方式
- 智能识别中文和英文答案
- 自动标准化答案格式

**判题流程：**
1. 标准化用户答案和正确答案
2. 支持多种表示方式（true/false, 对/错, 1/0等）
3. 比较标准化后的答案

**状态说明：**
- `accepted`: 答案正确
- `wrong_answer`: 答案错误或未选择

**支持的答案格式：**
- 英文：true, false, t, f, yes, no, y, n, 1, 0
- 中文：对, 错, 正确, 错误, 是, 否, 真, 假
- 大小写不敏感

### 4. 简答题判题 (judge_short_answer_problem)

**特点：**
- 基于相似度计算的智能判题
- 支持部分正确评分
- 结合Jaccard相似度和关键词匹配

**判题流程：**
1. 计算用户答案与参考答案的相似度
2. 使用综合算法评估答案质量
3. 根据相似度给出相应状态

**状态说明：**
- `accepted`: 相似度 ≥ 70%
- `partially_correct`: 相似度 50% - 70%
- `wrong_answer`: 相似度 < 50%

**相似度算法：**
- **Jaccard相似度** (70%权重): 基于词汇集合的相似度计算
- **关键词匹配度** (30%权重): 基于关键词的匹配程度
- **综合相似度**: 两种算法的加权平均

## 技术特性

### 1. 答案标准化
- 自动去除多余空格
- 统一大小写处理
- 支持多种输入格式

### 2. 错误处理
- 完善的异常捕获机制
- 详细的错误信息记录
- 优雅的失败处理

### 3. 日志记录
- 详细的判题过程日志
- 便于调试和问题排查
- 支持生产环境监控

### 4. 性能优化
- 非编程题判题速度极快
- 避免不必要的数据库查询
- 内存使用优化

## 使用方法

### 1. 启动判题服务
```bash
cd backend/judge-service
python judge.py
```

### 2. 测试判题模块
```bash
python test_judge_modules.py
```

### 3. 配置RabbitMQ
- 确保RabbitMQ服务运行在 localhost:5673
- 判题队列名称：judge_queue

## 数据库字段说明

### Problem表
- `type`: 题目类型 (programming/choice/judge/short_answer)
- `expected_output`: 正确答案/参考答案
- `choice_options`: 选择题选项（JSON格式）
- `is_multiple_choice`: 是否为多选题

### Submission表
- `code`: 用户提交的答案/代码
- `language`: 编程语言（非编程题为空）
- `status`: 判题状态
- `result`: 判题结果详情
- `execution_time`: 执行时间（非编程题为0）

## 扩展性

### 1. 添加新题型
1. 在Problem.type中添加新类型
2. 在judge.py中添加对应的判题函数
3. 在callback函数中添加类型分发逻辑

### 2. 自定义判题算法
- 可以修改相似度计算算法
- 支持自定义评分规则
- 支持机器学习模型集成

### 3. 多语言支持
- 支持不同语言的答案格式
- 可扩展国际化功能

## 注意事项

### 1. 数据库一致性
- 确保Problem.type字段正确设置
- 非编程题的test_cases可以为空
- 所有题型都需要expected_output

### 2. 判题服务稳定性
- 判题服务需要持续运行
- 建议使用进程管理工具（如supervisor）
- 定期检查日志和错误

### 3. 性能考虑
- 简答题相似度计算相对耗时
- 大量并发时考虑队列优化
- 可考虑异步判题提高响应速度

## 故障排除

### 1. 常见问题
- **RabbitMQ连接失败**: 检查RabbitMQ服务状态
- **判题结果异常**: 检查题目数据完整性
- **相似度计算错误**: 检查答案格式

### 2. 调试方法
- 查看判题服务日志
- 使用测试脚本验证功能
- 检查数据库数据完整性

### 3. 性能调优
- 调整相似度阈值
- 优化数据库查询
- 考虑缓存机制
