# 补交作业功能使用说明

## 🎯 功能概述

补交作业功能允许教师在作业截止后，为特定学生开放补交权限。补交的作业会被标记为"逾期提交"，并按照设定的比例得分。

## ✨ 主要特性

### **教师端功能**
- ✅ 设置作业是否允许补交
- ✅ 配置补交截止时间
- ✅ 设置逾期提交得分比例（0.0-1.0）
- ✅ 管理补交白名单用户
- ✅ 实时查看补交状态

### **学生端功能**
- ✅ 查看是否可以补交作业
- ✅ 显示补交截止时间和得分比例
- ✅ 实时状态更新
- ✅ 补交说明和注意事项

### **系统功能**
- ✅ 自动标记逾期提交
- ✅ 支持多种题目类型
- ✅ 数据库索引优化
- ✅ 权限控制和验证

## 🚀 快速开始

### **1. 数据库迁移**

首先运行数据库迁移脚本，添加必要的字段：

```bash
cd backend/main-service
python add_overdue_submission_migration.py
```

### **2. 启动服务**

```bash
# 启动主服务
cd backend/main-service
python app.py

# 启动判题服务
cd backend/judge-service
python judge.py

# 启动前端
cd frontend
npm start
```

### **3. 配置补交设置**

教师登录后，在课程详情页面：

1. 点击"布置作业"按钮
2. 在作业创建表单中勾选"允许补交作业"
3. 设置补交截止时间（必须晚于正常截止时间）
4. 调整逾期得分比例（0% - 100%）
5. 点击"布置作业"按钮

### **4. 管理白名单**

编辑作业时：

1. 在课程详情页面点击作业的"编辑"按钮
2. 在编辑表单中会显示"补交白名单管理"组件
3. 选择要添加的学生，点击"添加到白名单"
4. 可以随时移除白名单用户

## 📋 API接口说明

### **补交设置管理**

#### 更新补交设置
```
PUT /assignments/{assignment_id}/overdue-settings
```

**请求体：**
```json
{
  "allow_overdue_submission": true,
  "overdue_deadline": "2024-01-15T23:59:59",
  "overdue_score_ratio": 0.8
}
```

#### 获取白名单用户
```
GET /assignments/{assignment_id}/overdue-users
```

#### 添加用户到白名单
```
POST /assignments/{assignment_id}/overdue-users
```

**请求体：**
```json
{
  "user_id": 123
}
```

#### 从白名单移除用户
```
DELETE /assignments/{assignment_id}/overdue-users/{user_id}
```

### **学生权限检查**

#### 检查补交权限
```
GET /assignments/{assignment_id}/can-overdue-submit
```

**响应示例：**
```json
{
  "can_overdue": true,
  "overdue_deadline": "2024-01-15T23:59:59",
  "score_ratio": 0.8
}
```

## 🎨 前端组件使用

### **教师端集成**

补交作业功能已完全集成到现有的作业创建/编辑页面中：

1. **作业创建页面**：在"布置作业"表单中添加了补交设置部分
2. **作业编辑页面**：编辑作业时显示白名单管理组件
3. **课程详情页面**：作业表格中显示补交状态信息

### **学生端组件**

```jsx
import OverdueSubmissionStatus from './components/OverdueSubmissionStatus';

// 在作业详情页面中使用
<OverdueSubmissionStatus 
  assignment={assignment} 
  onStatusChange={handleStatusChange} 
/>
```

## 🔧 技术实现

### **数据库字段**

#### 作业表 (assignments)
- `allow_overdue_submission`: 是否允许补交
- `overdue_deadline`: 补交截止时间
- `overdue_allow_user_ids`: 白名单用户ID列表 (JSON)
- `overdue_score_ratio`: 逾期得分比例

#### 提交表 (submissions)
- `is_overdue`: 是否为逾期提交

### **判题逻辑**

1. 判题开始时检查提交是否逾期
2. 通过作业关联查找补交设置
3. 验证用户是否在白名单中
4. 标记提交状态为逾期
5. 应用得分比例（在判题结果中）

### **权限控制**

- 只有作业布置者可以修改补交设置
- 只有白名单中的学生可以补交
- 补交权限实时验证

## 📱 用户界面

### **教师端界面**
- 可折叠的补交管理面板
- 直观的设置控件（复选框、日期选择器、滑块）
- 白名单用户管理
- 实时状态显示

### **学生端界面**
- 清晰的状态指示（✅ 可补交 / ❌ 不可补交）
- 剩余时间显示
- 得分比例说明
- 补交规则说明

## 🧪 测试验证

运行测试脚本验证功能：

```bash
python test_overdue_submission.py
```

测试内容包括：
- 用户登录和权限验证
- 补交设置更新
- 白名单管理
- 补交权限检查

## ⚠️ 注意事项

### **数据兼容性**
- 新字段有默认值，不影响现有数据
- 旧作业默认不允许补交
- 白名单默认为空数组

### **性能考虑**
- 创建了相关索引优化查询
- 白名单数据缓存在前端
- 权限检查在判题时进行

### **安全考虑**
- 严格的权限验证
- 输入数据验证和清理
- 防止SQL注入

## 🚀 扩展功能

### **未来计划**
- [ ] 批量白名单管理
- [ ] 补交统计和报表
- [ ] 邮件通知功能
- [ ] 补交历史记录
- [ ] 自动审批流程

### **自定义扩展**
- 修改得分计算算法
- 添加更多补交条件
- 集成其他通知系统

## 📞 技术支持

如遇到问题，请检查：

1. 数据库迁移是否成功
2. 服务是否正常启动
3. 网络连接是否正常
4. 用户权限是否正确

## 📄 更新日志

### **v1.0.0 (2024-01-08)**
- ✅ 基础补交功能实现
- ✅ 白名单管理
- ✅ 前端组件开发
- ✅ 数据库迁移脚本
- ✅ API接口完整实现
- ✅ 判题服务集成
- ✅ 测试脚本和文档
